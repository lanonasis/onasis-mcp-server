name: Deploy to VPS (Improved)

on:
  push:
    branches: [ main, deploy-setup ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy MCP Server to VPS
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-bun-
        
    - name: Install dependencies
      run: bun install --frozen-lockfile
      
    - name: Build TypeScript
      id: build
      run: |
        echo "ðŸ”¨ Building TypeScript..."
        if bun run build; then
          echo "âœ… Build successful"
          echo "success=true" >> $GITHUB_OUTPUT
          echo "BUILD_STATUS=âœ… SUCCESS" >> $GITHUB_ENV
          
          # Verify build output
          if [ -d "dist" ]; then
            echo "ðŸ“ Build output:"
            ls -la dist/
          fi
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "BUILD_STATUS=âš ï¸ FAILED" >> $GITHUB_ENV
          echo "âš ï¸ Build failed - TypeScript compilation issues"
          echo "âš ï¸  Using existing ecosystem.config.js for deployment"
        fi

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        port: ${{ secrets.VPS_PORT }}
        username: ${{ secrets.VPS_USERNAME || 'root' }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ðŸš€ Starting deployment to VPS..."
          
          # Set deployment variables
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/mcp-servers/lanonasis-standalone' }}"
          SERVICE_NAME="lanonasis-mcp-server"
          
          # Navigate to deployment directory
          cd $DEPLOY_PATH
          
          # Pull latest changes
          echo "ðŸ“¥ Pulling latest changes..."
          git pull origin main
          
          # Install dependencies
          echo "ðŸ“¦ Installing dependencies..."
          bun install --production
          
          # Start/restart the service using ecosystem.config.js
          echo "ðŸ”„ Starting MCP server..."
          if [ -f "ecosystem.config.js" ]; then
            pm2 start ecosystem.config.js --env production
            echo "âœ… MCP server started with ecosystem config"
          else
            echo "âŒ ecosystem.config.js not found"
            exit 1
          fi
          
          # Verify service status
          echo "ðŸ“Š Service status:"
          pm2 status
          
          # Health check
          echo "ðŸ¥ Performing health check..."
          sleep 5
          if curl -f http://localhost:3001/health > /dev/null 2>&1; then
            echo "âœ… Health check passed"
          else
            echo "âš ï¸ Health check failed - service may need time to start"
          fi
          
          echo "ðŸŽ‰ Deployment completed successfully!"

    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ VPS Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Status**: ${{ steps.build.outputs.success == 'true' && 'âœ… Success' || 'âš ï¸ Failed (using existing config)' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Target**: ${{ secrets.VPS_HOST }}:${{ secrets.VPS_PORT }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deploy Path**: ${{ secrets.DEPLOY_PATH || '/opt/mcp-servers/lanonasis-standalone' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.build.outputs.success }}" == "true" ]; then
          echo "### ðŸ“‹ What was deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Fresh TypeScript build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Updated dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PM2 ecosystem configuration" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ“‹ Deployment used:" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ Existing build artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Updated dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PM2 ecosystem configuration" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor VPS logs for any runtime issues" >> $GITHUB_STEP_SUMMARY
        echo "- Verify MCP server is responding on port 3001" >> $GITHUB_STEP_SUMMARY
        echo "- Check PM2 status: \`pm2 status\`" >> $GITHUB_STEP_SUMMARY
